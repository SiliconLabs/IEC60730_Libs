name: Automation Trigger
on: 
  pull_request:
      types: [opened, edited, review_requested, synchronize, review_request_removed, reopened]
      branches:
        - main
        - iec_efr32

env:
  SECURITY: APP_SECURE=false
  COMMAND: all
  COMPONENT: all
jobs:
  job1:
    name: GCC-MG12 regression test
    runs-on: ubuntu-20.04
    permissions:
      contents: read
      pull-requests: write
    env: 
      HOST_IP: 192.168.1.69
      COMPILER: GCC
      PLATFORM: MG12
      TOOL_DIRS: docker/SimplicityStudio_v5/developer/toolchains/gnu_arm/10.3_2021.10/bin
      APP_TYPE: SecureApp
    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.7
    - name: Generate Firmware
      run: |
        pwd &&
        ls -la
        chmod -R 777 ./Test 
        cd Test/ &&
        ls -la &&
        ./execute_test.sh $COMMAND $COMPONENT $PLATFORM $COMPILER $SECURITY

    - name: Zip Release
      # You may pin to the exact commit or the version.
      # uses: TheDoctor0/zip-release@b57d897cb5d60cb78b51a507f63fa184cfe35554
      uses: TheDoctor0/zip-release@0.7.6
      with:
        # Filename for archive
        filename: firmware.7z
        # Base path for archive files
        path: artifact
        # Working directory before zipping
        directory: .
    - name: Upload artifact
      uses: actions/upload-artifact@v4.3.4
      with:
        name: firmware
        path: .
        warn: Output a warning but do not fail the action
        retention-days: 90
  
  job2:
    if: (always())
    needs: [job1]
    name: GCC-MG24 regression test
    runs-on: ubuntu-20.04
    permissions:
      contents: read
      pull-requests: write
    env:
      COMPILER: GCC
      PLATFORM: MG24
      TOOL_DIRS: /home/sqa/SimplicityStudio-5/SimplicityStudio_v5/developer/toolchains/gnu_arm/10.3_2021.10/bin
      APP_TYPE: SecureApp
    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.7
    - name: Generate Firmware
      run: |
        pwd &&
        ls -la
        chmod -R 777 ./Test 
        cd Test/ &&
        ls -la &&
        ./execute_test.sh $COMMAND $COMPONENT $PLATFORM $COMPILER $SECURITY

    - name: Zip Release
      # You may pin to the exact commit or the version.
      # uses: TheDoctor0/zip-release@b57d897cb5d60cb78b51a507f63fa184cfe35554
      uses: TheDoctor0/zip-release@0.7.6
      with:
        # Filename for archive
        filename: firmware.7z
        # Base path for archive files
        path: artifact
        # Working directory before zipping
        directory: .
    - name: Upload artifact
      uses: actions/upload-artifact@v4.3.4
      with:
        name: firmware
        path: .
        warn: Output a warning but do not fail the action
        retention-days: 90
  
  job3:
    if: (always())
    needs: [job1, job2]
    name: IAR-MG12 regression test
    runs-on: ubuntu-20.04
    permissions:
      contents: read
      pull-requests: write
    env: 
      COMPILER: IAR
      PLATFORM: MG12
      TOOL_DIRS: /home/sqa/EmbeddedWorkbench8.4/arm/bin
      APP_TYPE: SecureApp
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.7
    - name: Generate Firmware
      run: |
        pwd &&
        ls -la
        chmod -R 777 ./Test 
        cd Test/ &&
        ls -la &&
        ./execute_test.sh $COMMAND $COMPONENT $PLATFORM $COMPILER $SECURITY

    - name: Zip Release
      # You may pin to the exact commit or the version.
      # uses: TheDoctor0/zip-release@b57d897cb5d60cb78b51a507f63fa184cfe35554
      uses: TheDoctor0/zip-release@0.7.6
      with:
        # Filename for archive
        filename: firmware.7z
        # Base path for archive files
        path: artifact
        # Working directory before zipping
        directory: .
    - name: Upload artifact
      uses: actions/upload-artifact@v4.3.4
      with:
        name: firmware
        path: .
        warn: Output a warning but do not fail the action
        retention-days: 90
  
  job4:
    if: (always())
    needs: [job1, job2, job3]    
    name: IAR-MG24 regression test
    runs-on: ubuntu-20.04
    permissions:
      contents: read
      pull-requests: write
    env: 
      COMPILER: IAR
      PLATFORM: MG24
      TOOL_DIRS: /home/sqa/EmbeddedWorkbench8.4/arm/bin
      APP_TYPE: SecureApp
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.7
    - name: Generate Firmware
      run: |
        pwd &&
        ls -la
        chmod -R 777 ./Test 
        cd Test/ &&
        ls -la &&
        ./execute_test.sh $COMMAND $COMPONENT $PLATFORM $COMPILER $SECURITY

    - name: Zip Release
      # You may pin to the exact commit or the version.
      # uses: TheDoctor0/zip-release@b57d897cb5d60cb78b51a507f63fa184cfe35554
      uses: TheDoctor0/zip-release@0.7.6
      with:
        # Filename for archive
        filename: firmware.7z
        # Base path for archive files
        path: artifact
        # Working directory before zipping
        directory: .
    - name: Upload artifact
      uses: actions/upload-artifact@v4.3.4
      with:
        name: firmware
        path: .
        warn: Output a warning but do not fail the action
        retention-days: 90
    
  
  
          
